{"version":3,"file":"plugins/plugin.archive_analytics.js","mappings":"26BAMO,IAAMA,EAAgB,WAW3B,O,EAPA,SAAAA,EAAYC,I,4FAAIC,CAAA,KAAAF,GAEdG,KAAKF,GAAKA,EAEVE,KAAKC,OACP,G,EAEA,EAAAC,IAAA,QAAAC,MAIA,SAAMF,GACJD,KAAKC,QAAUG,OAAOC,OAAO,CAAC,EAAGL,KAAKC,QAASA,EACjD,GAEA,CAAAC,IAAA,OAAAC,MACA,WAAQ,GAER,CAAAD,IAAA,0BAAAC,MAKA,SAAwBG,GACxB,GAEA,CAAAJ,IAAA,oBAAAC,MAKA,SAAkBI,GAClB,GAEA,CAAAL,IAAA,0BAAAC,MACA,WAA2B,GAE3B,CAAAD,IAAA,eAAAC,MAGA,SAAaK,GAAU,M,6EAAC,CA5CG,E,stDCH7B,IAAMC,EAAmEC,OAAOD,WAGnEE,EAAsB,SAAAC,GAAA,SAAAD,IAAA,IAAAE,G,4FAAAd,CAAA,KAAAY,GAAA,QAAAG,EAAAC,UAAAC,OAAAC,EAAA,IAAAC,MAAAJ,GAAAK,EAAA,EAAAA,EAAAL,EAAAK,IAAAF,EAAAE,GAAAJ,UAAAI,GAQb,OARaC,EAAAP,EAAAQ,EAAA,KAAAV,EAAA,GAAAW,OAAAL,IAAA,UACvB,CACRM,SAAS,EAETC,OAAO,IAGTJ,EAAAP,EAAA,gBACgB,MAAIA,CAAA,Q,qRAAAY,CAAAd,EAAAC,G,EAAAD,E,EAAA,EAAAT,IAAA,OAAAC,MAGpB,WAAO,IAAAuB,EAAA,KACD1B,KAAKC,QAAQsB,SACfvB,KAAKF,GAAG6B,KAAKlB,EAAWmB,WAAWC,gBAAgB,kBAAMH,EAAKI,oBAAoB,GAEtF,GAEA,CAAA5B,IAAA,qBAAAC,MACA,WACE,GAAKO,OAAOqB,kBAAZ,CAIA,IAAMC,EAAehC,KAAKiC,cAEpBC,EAASlC,KAAKF,GAAGqC,oBACjBC,EAAcpC,KAAKF,GAAGuC,mBAAmBH,GAE/C,GAAIF,GAAgBI,EAAa,KAAAE,EACzBC,EAAS,CACbC,WAAY,oBACZC,OAAQzC,KAAKF,GAAG4C,OAChBC,WAAYC,KAAKC,SAGnBN,QAAiB,EACjBA,QAAiB,GACjB,IACEA,EAAOO,QAAUpC,OAAOqC,IAAIC,SAASC,SAASC,MAAM,kBAChD,EACA,EACJX,EAAOY,SACJZ,EAAOO,SAAWpC,OAAOqC,IAAIC,SAASI,SAASF,MAAM,gBAClD,EACA,CACR,CAAE,MAAOG,GAAK,CAId3C,OAAOqB,kBAAkBuB,UAAUf,EAAQ,KAAM,uBAGjD,IAAMgB,EAAmD,QAA3BjB,EAAAtC,KAAKF,GAAGG,QAAQuD,mBAAW,IAAAlB,GAA3BA,EAA6BmB,OACvD,CAAEA,OAAQzD,KAAKF,GAAGG,QAAQuD,YAAYC,QACtC,CAAC,EACL/C,OAAOqB,kBAAkB2B,WAAW,aAAc,kBAAmBhD,OAAOsC,SAASI,SAAUG,GAE/FvD,KAAKiC,cAAgBG,CACvB,CArCA,CAsCF,GAEA,CAAAlC,IAAA,YAAAC,MAOA,SAAUwD,EAAUC,EAAQzD,EAAOoD,GAC5BvD,KAAKC,QAAQsB,UAEdvB,KAAKC,QAAQuB,OACfqC,QAAQC,IAAI,4BAA6B/C,UAAWL,OAAOqB,mBAGxDrB,OAAOqB,oBAEZwB,EAAwBA,GAAyB,CAAC,EAC5B,iBAAVpD,IACVoD,EAAsBQ,GAAK5D,GAE7BO,OAAOqB,kBAAkB2B,WAAWC,EAAUC,EAAQ,KAAML,IAC9D,I,gFAAC,CAlFgC,CAAS1D,EAAAA,GAqF5CY,SAAAA,EAAYuD,eAAe,mBAAoBrD,E","sources":["webpack://@internetarchive/bookreader/./src/BookReaderPlugin.js","webpack://@internetarchive/bookreader/./src/plugins/plugin.archive_analytics.js"],"sourcesContent":["// @ts-check\r\n/** @typedef {import(\"./BookReader.js\").default} BookReader */\r\n\r\n/**\r\n * @template TOptions\r\n */\r\nexport class BookReaderPlugin {\r\n  /**\r\n   * @param {BookReader} br\r\n   */\r\n  constructor(br) {\r\n    /** @type {BookReader} */\r\n    this.br = br;\r\n    /** @type {TOptions} */\r\n    this.options;\r\n  }\r\n\r\n  /**\r\n   * @abstract\r\n   * @param {TOptions} options\r\n   **/\r\n  setup(options) {\r\n    this.options = Object.assign({}, this.options, options);\r\n  }\r\n\r\n  /** @abstract */\r\n  init() {}\r\n\r\n  /**\r\n   * @abstract\r\n   * @protected\r\n   * @param {import (\"./BookReader/PageContainer.js\").PageContainer} pageContainer\r\n   */\r\n  _configurePageContainer(pageContainer) {\r\n  }\r\n\r\n  /**\r\n   * @abstract\r\n   * @protected\r\n   * @param {JQuery<HTMLElement>} $toolbarElement\r\n   */\r\n  _configureToolbar($toolbarElement) {\r\n  }\r\n\r\n  /** @abstract @protected */\r\n  _bindNavigationHandlers() {}\r\n\r\n  /**\r\n   * @param {JQuery<HTMLElement>} $navBar\r\n   */\r\n  extendNavBar($navBar) {}\r\n}\r\n","// @ts-check\r\nimport { BookReaderPlugin } from \"../BookReaderPlugin.js\";\r\n\r\nconst BookReader = /** @type {typeof import('../BookReader').default} */(window.BookReader);\r\n\r\n\r\nexport class ArchiveAnalyticsPlugin extends BookReaderPlugin {\r\n  options = {\r\n    enabled: true,\r\n    /** Provide a means of debugging, cause otherwise it's impossible to test locally */\r\n    debug: false,\r\n  }\r\n\r\n  /** @type {string} */\r\n  _prevFragment = null;\r\n\r\n  /** @override */\r\n  init() {\r\n    if (this.options.enabled) {\r\n      this.br.bind(BookReader.eventNames.fragmentChange, () => this.sendFragmentChange());\r\n    }\r\n  }\r\n\r\n  /** @private */\r\n  sendFragmentChange() {\r\n    if (!window.archive_analytics) {\r\n      return;\r\n    }\r\n\r\n    const prevFragment = this._prevFragment;\r\n\r\n    const params = this.br.paramsFromCurrent();\r\n    const newFragment = this.br.fragmentFromParams(params);\r\n\r\n    if (prevFragment != newFragment) {\r\n      const values = {\r\n        bookreader: \"user_changed_view\",\r\n        itemid: this.br.bookId,\r\n        cache_bust: Math.random(),\r\n      };\r\n      // EEK!  offsite embedding and /details/ page books look the same in analytics, otherwise!\r\n      values.offsite = 1;\r\n      values.details = 0;\r\n      try {\r\n        values.offsite = window.top.location.hostname.match(/\\.archive.org$/)\r\n          ? 0\r\n          : 1;\r\n        values.details =\r\n          !values.offsite && window.top.location.pathname.match(/^\\/details\\//)\r\n            ? 1\r\n            : 0;\r\n      } catch (e) { }\r\n      // avoids embed cross site exceptions -- but on (+) side, means it is and keeps marked offite!\r\n\r\n      // Send bookreader ping\r\n      window.archive_analytics.send_ping(values, null, \"augment_for_ao_site\");\r\n\r\n      // Also send tracking event ping\r\n      const additionalEventParams = this.br.options.lendingInfo?.loanId\r\n        ? { loanId: this.br.options.lendingInfo.loanId }\r\n        : {};\r\n      window.archive_analytics.send_event('BookReader', 'UserChangedView', window.location.pathname, additionalEventParams);\r\n\r\n      this._prevFragment = newFragment;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Sends a tracking \"Event\". See https://developers.google.com/analytics/devguides/collection/protocol/v1/parameters#events\r\n   * @param {string} category\r\n   * @param {string} action\r\n   * @param {number} [value] (must be an int)\r\n   * @param {Object} [additionalEventParams]\r\n   */\r\n  sendEvent(category, action, value, additionalEventParams) {\r\n    if (!this.options.enabled) return;\r\n\r\n    if (this.options.debug) {\r\n      console.log(\"archiveAnalyticsSendEvent\", arguments, window.archive_analytics);\r\n    }\r\n\r\n    if (!window.archive_analytics) return;\r\n\r\n    additionalEventParams = additionalEventParams || {};\r\n    if (typeof (value) == 'number') {\r\n      additionalEventParams.ev = value;\r\n    }\r\n    window.archive_analytics.send_event(category, action, null, additionalEventParams);\r\n  }\r\n}\r\n\r\nBookReader?.registerPlugin('archiveAnalytics', ArchiveAnalyticsPlugin);\r\n"],"names":["BookReaderPlugin","br","_classCallCheck","this","options","key","value","Object","assign","pageContainer","$toolbarElement","$navBar","BookReader","window","ArchiveAnalyticsPlugin","_BookReaderPlugin","_this","_len","arguments","length","args","Array","_key","_defineProperty","_callSuper","concat","enabled","debug","_inherits","_this2","bind","eventNames","fragmentChange","sendFragmentChange","archive_analytics","prevFragment","_prevFragment","params","paramsFromCurrent","newFragment","fragmentFromParams","_this$br$options$lend","values","bookreader","itemid","bookId","cache_bust","Math","random","offsite","top","location","hostname","match","details","pathname","e","send_ping","additionalEventParams","lendingInfo","loanId","send_event","category","action","console","log","ev","registerPlugin"],"sourceRoot":""}