{"version":3,"file":"plugins/plugin.resume.js","mappings":"26BAMO,IAAMA,EAAgB,WAW3B,O,EAPA,SAAAA,EAAYC,I,4FAAIC,CAAA,KAAAF,GAEdG,KAAKF,GAAKA,EAEVE,KAAKC,OACP,G,EAEA,EAAAC,IAAA,QAAAC,MAIA,SAAMF,GACJD,KAAKC,QAAUG,OAAOC,OAAO,CAAC,EAAGL,KAAKC,QAASA,EACjD,GAEA,CAAAC,IAAA,OAAAC,MACA,WAAQ,GAER,CAAAD,IAAA,0BAAAC,MAKA,SAAwBG,GACxB,GAEA,CAAAJ,IAAA,oBAAAC,MAKA,SAAkBI,GAClB,GAEA,CAAAL,IAAA,0BAAAC,MACA,WAA2B,GAE3B,CAAAD,IAAA,eAAAC,MAGA,SAAaK,GAAU,M,6EAAC,CA5CG,E,uUCUtB,SAASC,IAAkC,IAAhBC,EAAGC,UAAAC,OAAA,QAAAC,IAAAF,UAAA,GAAAA,UAAA,GAAGG,SACtC,IAEE,OADAJ,EAAIK,QACG,CACT,CAAE,MAAOC,GACP,OAAO,CACT,CACF,C,wBAEA,I,EAAMC,EAAkBR,IASjB,SAASS,EAAQC,GACtB,OAAIF,IAAoBE,EAAa,KAE9BC,mBAELN,SAASC,OAAOM,QAAQ,IAAIC,OAAO,mBAAqBC,mBAAmBJ,GAAME,QAAQ,cAAe,QAAU,+BAAgC,QAAU,IAChK,CAcO,SAASG,EAAQL,EAAMM,EAAQC,EAAMC,EAAOC,EAASC,GAC1D,OAAIZ,IAEJH,SAASC,OAASQ,mBAAmBJ,GAAQ,IAAMI,mBAAmBE,IACnEC,EAAO,aAAHI,OAAgBJ,EAAKK,eAAkB,KAC3CH,EAAU,YAAHE,OAAeF,GAAY,KAClCD,EAAQ,UAAHG,OAAaH,GAAU,KAC5BE,EAAU,WAAa,KAEnB,EACT,CAWO,SAASG,EAAWb,EAAMQ,EAAOC,GACtC,OAAIX,KAECgB,QAAQd,KAEbL,SAASC,OAASQ,mBAAmBJ,GAAQ,4CAC1CS,EAAU,YAAHE,OAAeF,GAAY,KAClCD,EAAQ,UAAHG,OAAaH,GAAU,KAExB,EACT,C,87CC9EAO,WAAWC,WAAaA,EAKjB,IAAMC,EAAY,SAAAC,GAAA,SAAAD,IAAA,IAAAE,E,mGAAAvC,CAAA,KAAAqC,GAAA,QAAAG,EAAA5B,UAAAC,OAAA4B,EAAA,IAAAC,MAAAF,GAAAG,EAAA,EAAAA,EAAAH,EAAAG,IAAAF,EAAAE,GAAA/B,UAAA+B,GAKtB,O,EALsBJ,EAAAK,EAAA,KAAAP,EAAA,GAAAN,OAAAU,I,EACb,CACRI,SAAS,EAETC,WAAY,O,MAJS,c,wFAKtBP,CAAA,Q,qRAAAQ,CAAAV,EAAAC,G,EAAAD,G,EAAA,EAAAlC,IAAA,OAAAC,MAGD,WAAO,IAAA4C,EAAA,KACD/C,KAAKC,QAAQ2C,SACf5C,KAAKF,GAAGkD,KAAKC,EAAAA,EAAOC,gBAAgB,WAClC,IAAMC,EAASJ,EAAKjD,GAAGsD,oBACvBL,EAAKM,kBAAkBF,EAAOG,MAChC,GAEJ,GAEA,CAAApD,IAAA,iBAAAC,MAMA,WACE,IAAMoD,EAAMrB,WAAWC,WAAWjB,QAAQ,aAC1C,OAAY,OAARqC,EAAqBC,SAASD,GACtB,IACd,GAEA,CAAArD,IAAA,gBAAAC,MAQA,SAAcsD,GACZ,OAAOA,EAAYC,MAAM,0BAA0B,EACrD,GAEA,CAAAxD,IAAA,oBAAAC,MAOA,SAAkBmD,EAAOK,GACvB,IAAMC,EAAM,IAAIC,MAAM,IAAIA,KAAO,SAG3BC,EAAO9D,KAAKC,QAAQ4C,YACrB7C,KAAK+D,cAAcC,OAAOC,SAASC,UACxChC,WAAWC,WAAWX,QAAQmC,GAAc,YAAaL,EAAOM,EAAKE,EAAM,MAAM,EACnF,M,6EAAC,CAvDsB,CAASjE,EAAAA,GA0DxB,QAAVsE,EAAAjC,kBAAU,IAAAiC,GAAVA,EAAYC,eAAe,SAAUhC,E","sources":["webpack://@internetarchive/bookreader/./src/BookReaderPlugin.js","webpack://@internetarchive/bookreader/./src/util/docCookies.js","webpack://@internetarchive/bookreader/./src/plugins/plugin.resume.js"],"sourcesContent":["// @ts-check\r\n/** @typedef {import(\"./BookReader.js\").default} BookReader */\r\n\r\n/**\r\n * @template TOptions\r\n */\r\nexport class BookReaderPlugin {\r\n  /**\r\n   * @param {BookReader} br\r\n   */\r\n  constructor(br) {\r\n    /** @type {BookReader} */\r\n    this.br = br;\r\n    /** @type {TOptions} */\r\n    this.options;\r\n  }\r\n\r\n  /**\r\n   * @abstract\r\n   * @param {TOptions} options\r\n   **/\r\n  setup(options) {\r\n    this.options = Object.assign({}, this.options, options);\r\n  }\r\n\r\n  /** @abstract */\r\n  init() {}\r\n\r\n  /**\r\n   * @abstract\r\n   * @protected\r\n   * @param {import (\"./BookReader/PageContainer.js\").PageContainer} pageContainer\r\n   */\r\n  _configurePageContainer(pageContainer) {\r\n  }\r\n\r\n  /**\r\n   * @abstract\r\n   * @protected\r\n   * @param {JQuery<HTMLElement>} $toolbarElement\r\n   */\r\n  _configureToolbar($toolbarElement) {\r\n  }\r\n\r\n  /** @abstract @protected */\r\n  _bindNavigationHandlers() {}\r\n\r\n  /**\r\n   * @param {JQuery<HTMLElement>} $navBar\r\n   */\r\n  extendNavBar($navBar) {}\r\n}\r\n","/**\r\n * Helper module use to get, set and remove item from cookie\r\n *\r\n * See more:\r\n *  https://developer.mozilla.org/en-US/docs/Web/API/document.cookie\r\n *  https://developer.mozilla.org/User:fusionchess\r\n *  https://github.com/madmurphy/cookies.js\r\n *  This framework is released under the GNU Public License, version 3 or later.\r\n *  http://www.gnu.org/licenses/gpl-3.0-standalone.html\r\n */\r\n\r\n/**\r\n * Check to see if the browser has cookies enabled.\r\n * Accessing document.cookies errors if eg iframe with sandbox enabled.\r\n * @returns {boolean}\r\n */\r\nexport function areCookiesBlocked(doc = document) {\r\n  try {\r\n    doc.cookie;\r\n    return false;\r\n  } catch (e) {\r\n    return true;\r\n  }\r\n}\r\n\r\nconst COOKIES_BLOCKED = areCookiesBlocked();\r\n\r\n/**\r\n * Get specific key's value stored in cookie\r\n *\r\n * @param {string} sKey\r\n *\r\n * @returns {string|null}\r\n */\r\nexport function getItem(sKey) {\r\n  if (COOKIES_BLOCKED || !sKey) return null;\r\n\r\n  return decodeURIComponent(\r\n    // eslint-disable-next-line no-useless-escape\r\n    document.cookie.replace(new RegExp('(?:(?:^|.*;)\\\\s*' + encodeURIComponent(sKey).replace(/[\\-\\.\\+\\*]/g, '\\\\$&') + '\\\\s*\\\\=\\\\s*([^;]*).*$)|^.*$'), '$1')) || null;\r\n}\r\n\r\n/**\r\n * Set specific key's value in cookie\r\n *\r\n * @param {string} sKey cookie name\r\n * @param {string} sValue cookie value\r\n * @param {string} [vEnd] expire|max-age\r\n * @param {string} [sPath] path of current item\r\n * @param {string} [sDomain] domain name\r\n * @param {boolean} [bSecure]\r\n *\r\n * @returns {boolean}\r\n */\r\nexport function setItem(sKey, sValue, vEnd, sPath, sDomain, bSecure) {\r\n  if (COOKIES_BLOCKED) return false;\r\n\r\n  document.cookie = encodeURIComponent(sKey) + '=' + encodeURIComponent(sValue)\r\n  + (vEnd ? `; expires=${vEnd.toUTCString()}` : '')\r\n  + (sDomain ? `; domain=${sDomain}` : '')\r\n  + (sPath ? `; path=${sPath}` : '')\r\n  + (bSecure ? `; secure` : '');\r\n\r\n  return true;\r\n}\r\n\r\n/**\r\n * BROKEN Remove specific key's value from cookie\r\n * @fixme hasItem isn't even implemented! This will always error.\r\n * @param {string} sKey cookie name\r\n * @param {string} [sPath] path of current item\r\n * @param {string} [sDomain]\r\n *\r\n * @returns {boolean}\r\n */\r\nexport function removeItem(sKey, sPath, sDomain) {\r\n  if (COOKIES_BLOCKED) return false;\r\n  // eslint-disable-next-line\r\n  if (!hasItem(sKey)) return false;\r\n\r\n  document.cookie = encodeURIComponent(sKey) + `=; expires=Thu, 01 Jan 1970 00:00:00 GMT`\r\n  + (sDomain ? `; domain=${sDomain}` : '')\r\n  + (sPath ? `; path=${sPath}` : '');\r\n\r\n  return true;\r\n}\r\n","import { EVENTS } from '../BookReader/events.js';\r\nimport { BookReaderPlugin } from '../BookReaderPlugin.js';\r\nimport * as docCookies from '../util/docCookies.js';\r\n\r\n/* global BookReader */\r\n\r\n/** @deprecated Exposed for backward compatibility */\r\nBookReader.docCookies = docCookies;\r\n\r\n/**\r\n * Plugin to remember the current page number in a cookie\r\n */\r\nexport class ResumePlugin extends BookReaderPlugin {\r\n  options = {\r\n    enabled: true,\r\n    /** @type {string|null} eg '/', '/details/id' */\r\n    cookiePath: null,\r\n  }\r\n\r\n  /** @override */\r\n  init() {\r\n    if (this.options.enabled) {\r\n      this.br.bind(EVENTS.fragmentChange, () => {\r\n        const params = this.br.paramsFromCurrent();\r\n        this.updateResumeValue(params.index);\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Gets page resume value, for remembering reader's page\r\n   * Can be overridden for different implementation\r\n   *\r\n   * @return {number|null}\r\n   */\r\n  getResumeValue() {\r\n    const val = BookReader.docCookies.getItem('br-resume');\r\n    if (val !== null) return parseInt(val);\r\n    else return null;\r\n  }\r\n\r\n  /**\r\n   * Return cookie path using pathname up to /page/... or /mode/...\r\n   * using window.location.pathname for urlPathPart:\r\n   * - matches encoding\r\n   * - ignores querystring part\r\n   * - ignores fragment part (after #)\r\n   * @param {string} urlPathPart - window.location.pathname\r\n   */\r\n  getCookiePath(urlPathPart) {\r\n    return urlPathPart.match('.+?(?=/page/|/mode/|$)')[0];\r\n  }\r\n\r\n  /**\r\n   * Sets page resume value, for remembering reader's page\r\n   * Can be overridden for different implementation\r\n   *\r\n   * @param {Number} index leaf index\r\n   * @param {string} [cookieName]\r\n   */\r\n  updateResumeValue(index, cookieName) {\r\n    const ttl = new Date(+new Date + 12096e5); // 2 weeks\r\n    // For multiple files in item, leave cookiePath blank\r\n    // It's likely we can remove cookiePath using getCookiePath()\r\n    const path = this.options.cookiePath\r\n      || this.getCookiePath(window.location.pathname);\r\n    BookReader.docCookies.setItem(cookieName || 'br-resume', index, ttl, path, null, false);\r\n  }\r\n}\r\n\r\nBookReader?.registerPlugin('resume', ResumePlugin);\r\n"],"names":["BookReaderPlugin","br","_classCallCheck","this","options","key","value","Object","assign","pageContainer","$toolbarElement","$navBar","areCookiesBlocked","doc","arguments","length","undefined","document","cookie","e","COOKIES_BLOCKED","getItem","sKey","decodeURIComponent","replace","RegExp","encodeURIComponent","setItem","sValue","vEnd","sPath","sDomain","bSecure","concat","toUTCString","removeItem","hasItem","BookReader","docCookies","ResumePlugin","_BookReaderPlugin","_this","_len","args","Array","_key","_callSuper","enabled","cookiePath","_inherits","_this2","bind","EVENTS","fragmentChange","params","paramsFromCurrent","updateResumeValue","index","val","parseInt","urlPathPart","match","cookieName","ttl","Date","path","getCookiePath","window","location","pathname","_BookReader","registerPlugin"],"sourceRoot":""}