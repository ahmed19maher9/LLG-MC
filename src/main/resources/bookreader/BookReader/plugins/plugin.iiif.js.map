{"version":3,"file":"plugins/plugin.iiif.js","mappings":"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","sources":["webpack://@internetarchive/bookreader/./src/BookReaderPlugin.js","webpack://@internetarchive/bookreader/./src/plugins/plugin.iiif.js"],"sourcesContent":["// @ts-check\r\n/** @typedef {import(\"./BookReader.js\").default} BookReader */\r\n\r\n/**\r\n * @template TOptions\r\n */\r\nexport class BookReaderPlugin {\r\n  /**\r\n   * @param {BookReader} br\r\n   */\r\n  constructor(br) {\r\n    /** @type {BookReader} */\r\n    this.br = br;\r\n    /** @type {TOptions} */\r\n    this.options;\r\n  }\r\n\r\n  /**\r\n   * @abstract\r\n   * @param {TOptions} options\r\n   **/\r\n  setup(options) {\r\n    this.options = Object.assign({}, this.options, options);\r\n  }\r\n\r\n  /** @abstract */\r\n  init() {}\r\n\r\n  /**\r\n   * @abstract\r\n   * @protected\r\n   * @param {import (\"./BookReader/PageContainer.js\").PageContainer} pageContainer\r\n   */\r\n  _configurePageContainer(pageContainer) {\r\n  }\r\n\r\n  /**\r\n   * @abstract\r\n   * @protected\r\n   * @param {JQuery<HTMLElement>} $toolbarElement\r\n   */\r\n  _configureToolbar($toolbarElement) {\r\n  }\r\n\r\n  /** @abstract @protected */\r\n  _bindNavigationHandlers() {}\r\n\r\n  /**\r\n   * @param {JQuery<HTMLElement>} $navBar\r\n   */\r\n  extendNavBar($navBar) {}\r\n}\r\n","// @ts-check\r\nimport { BookReaderPlugin } from '../BookReaderPlugin.js';\r\n\r\nconst BookReader = /** @type {typeof import('../BookReader').default} */(window.BookReader);\r\n\r\nexport class IiifPlugin extends BookReaderPlugin {\r\n  options = {\r\n    enabled: true,\r\n    /** @type {import('@iiif/presentation-3').Manifest | import('@iiif/presentation-2').Manifest} */\r\n    manifest: null,\r\n  }\r\n\r\n  setup(options) {\r\n    super.setup(options);\r\n    this.manifest = this.options.manifest;\r\n\r\n    if (this.options.enabled) {\r\n      Object.assign(this.br.options, this.load());\r\n    }\r\n  }\r\n\r\n  load() {\r\n    if (this.manifest[\"@context\"] == \"http://iiif.io/api/presentation/2/context.json\") {\r\n      const manifest = /** @type {import('@iiif/presentation-2').Manifest} */(this.manifest);\r\n      return this.manifestToBookReaderV2(manifest);\r\n    } else if (this.manifest[\"@context\"] == \"http://iiif.io/api/presentation/3/context.json\") {\r\n      const manifest = /** @type {import('@iiif/presentation-3').Manifest} */(this.manifest);\r\n      return this.manifestToBookReaderV3(manifest);\r\n    } else {\r\n      throw new Error(\"Unsupported IIIF context \" + this.manifest[\"@context\"]);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * @param {import('@iiif/presentation-3').Manifest} manifest\r\n   */\r\n  manifestToBookReaderV3(manifest) {\r\n    /** @type {import('../BookReader/options.js').BookReaderOptions} */\r\n    const book = {\r\n      bookTitle: resolveInternationalString(manifest.label),\r\n      pageProgression: manifest.viewingDirection == \"right-to-left\" ? \"rl\" : \"lr\",\r\n      // numLeafs: manifest.items.length,\r\n      metadata: (manifest.metadata || []).map((metadata) => {\r\n        return {\r\n          label: resolveInternationalString(metadata.label),\r\n          value: resolveInternationalString(metadata.value),\r\n        };\r\n      }),\r\n      data: [],\r\n      /**\r\n       * @this {import('../BookReader.js').default}\r\n       */\r\n      getPageURI(pageIndex, reduce, rotate) {\r\n        const percent = Math.floor(100 * 1 / reduce);\r\n        const bodyArr = manifest.items[pageIndex].items[0].items[0].body;\r\n        const body = bodyArr instanceof Array ? bodyArr[0] : bodyArr;\r\n        const uri = body.service[0].id;\r\n        return `${uri}/full/pct:${percent}/0/default.jpg`;\r\n      },\r\n    };\r\n\r\n    if (manifest.viewingDirection == \"top-to-bottom\" || manifest.viewingDirection == \"bottom-to-top\") {\r\n      console.warn(\"Unsupported viewingDirection\", manifest.viewingDirection);\r\n    }\r\n\r\n    let spread = [];\r\n    manifest.items.forEach((item, index) => {\r\n      const bodyArr = manifest.items[index].items[0].items[0].body;\r\n      const body = bodyArr instanceof Array ? bodyArr[0] : bodyArr;\r\n      const uri = body.service[0].id;\r\n      /** @type {import('../BookReader/options.js').PageData} */\r\n      const pageData = {\r\n        uri,\r\n        width: item.width,\r\n        height: item.height,\r\n        pageNum: resolveInternationalString(item.label),\r\n      };\r\n      spread.push(pageData);\r\n      if (index % 2 == 0) {\r\n        book.data.push(spread);\r\n        spread = [];\r\n      }\r\n    });\r\n    if (spread.length > 0) {\r\n      book.data.push(spread);\r\n    }\r\n    return book;\r\n  }\r\n\r\n  /**\r\n   * @param {import('@iiif/presentation-2').Manifest} manifest\r\n   */\r\n  manifestToBookReaderV2(manifest) {\r\n    /** @type {import('../BookReader/options.js').BookReaderOptions} */\r\n    const book = {\r\n      bookTitle: manifest.label,\r\n      metadata: manifest.metadata,\r\n      thumbnail: manifest.thumbnail?.['@id'],\r\n      // numLeafs: manifest.sequences[0].canvases.length,\r\n      data: [],\r\n      /**\r\n       * @this {import('../BookReader.js').default}\r\n       */\r\n      getPageURI(pageIndex, reduce, rotate) {\r\n        const percent = Math.floor(100 * 1 / reduce);\r\n        const uri = manifest.sequences[0].canvases[pageIndex].images[0].resource.service['@id'];\r\n        return `${uri}/full/pct:${percent}/0/default.jpg`;\r\n      },\r\n    };\r\n\r\n    let spread = [];\r\n    manifest.sequences[0].canvases.forEach((canvas, index) => {\r\n      /** @type {import('../BookReader/options.js').PageData} */\r\n      const pageData = {\r\n        uri: canvas.images[0].resource.service['@id'],\r\n        width: canvas.width,\r\n        height: canvas.height,\r\n        pageNum: canvas.label,\r\n      };\r\n      spread.push(pageData);\r\n      if (index % 2 == 0) {\r\n        book.data.push(spread);\r\n        spread = [];\r\n      }\r\n    });\r\n    if (spread.length > 0) {\r\n      book.data.push(spread);\r\n    }\r\n    return book;\r\n  }\r\n}\r\n\r\n/**\r\n * @param {import('@iiif/presentation-3').InternationalString} internationalString\r\n */\r\nfunction resolveInternationalString(internationalString) {\r\n  const anyLang = Object.keys(internationalString)[0];\r\n  return (internationalString[navigator.language] || internationalString[anyLang])[0];\r\n}\r\n\r\nBookReader?.registerPlugin('iiif', IiifPlugin);\r\n"],"names":["BookReaderPlugin","br","_classCallCheck","this","options","key","value","Object","assign","pageContainer","$toolbarElement","$navBar","BookReader","window","IiifPlugin","_BookReaderPlugin","_this","_len","arguments","length","args","Array","_key","_callSuper","concat","enabled","manifest","_inherits","load","manifestToBookReaderV2","manifestToBookReaderV3","Error","book","bookTitle","resolveInternationalString","label","pageProgression","viewingDirection","metadata","map","data","getPageURI","pageIndex","reduce","rotate","percent","Math","floor","bodyArr","items","body","uri","service","id","console","warn","spread","forEach","item","index","pageData","width","height","pageNum","push","_manifest$thumbnail","thumbnail","sequences","canvases","images","resource","canvas","internationalString","anyLang","keys","navigator","language","registerPlugin"],"sourceRoot":""}